- name: Install Basic Packages
  apt: name={{ item }} state=present update_cache=yes
  with_items:
    - git
    - build-essential
    - libpcre3
    - libpcre3-dev
    - libssl-dev
    - wget
    - unzip

- name: Create working directory
  file: path=/home/vagrant/working state=directory

- name: Download Nginx
  get_url:
    url: 'http://nginx.org/download/nginx-1.11.9.tar.gz'
    dest: /home/vagrant/working

- name: Download Nginx-RTMP-Module
  get_url:
    url: 'https://github.com/arut/nginx-rtmp-module/archive/master.zip'
    dest: /home/vagrant/working

- name: Tar nginx
  shell: 'cd /home/vagrant/working && tar -zxvf nginx-1.11.9.tar.gz'

- name: Unzip Nginx-RTMP-Module
  shell: 'cd /home/vagrant/working && unzip nginx-rtmp-module-master.zip'

- name: Install Nginx
  shell: "cd /home/vagrant/working/nginx-1.11.9 && {{ item }}"
  with_items:
    - ./configure --with-http_ssl_module --add-module=../nginx-rtmp-module-master
    - make
    - make install

- name: Install Nginx init script
  get_url:
    url: 'https://raw.github.com/JasonGiedymin/nginx-init-ubuntu/master/nginx'
    dest: /etc/init.d/nginx

- name: Change Permission
  shell: 'chmod +x /etc/init.d/nginx'

- name: Update nginx
  shell: 'update-rc.d nginx defaults'
  notify: restart nginx
